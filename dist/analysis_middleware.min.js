!function(t){"function"==typeof define&&define.amd?define(t):t()}(function(){"use strict";var t,e;t=void 0,e=function(){var r={"-2":"basic params error",1014:"args non-conform to the template",1001:"date range error"},e=(t.prototype.get=function(t,e,r,n){return this.CGI&&"[object Function]"===Object.prototype.toString.call(this.CGI.post)?this.getData(t).then(function(t){return r&&r(t,e)}).catch(function(t){return n&&n(t)}):null},t.prototype.getData=function(n){var a=this,o=n.busi,i=n.tmpl,s=n.args;return new Promise(function(e,r){var t=a.verifyRequest(n);t.errMsg?r(t):a.CGI.post({url:"/misc/datacubequery",data:{action:"query",busi:o,tmpl:i,args:JSON.stringify(s)}},function(t){(t=a.addRetMsg(t))&&t.base_resp&&0===t.base_resp.ret?e(t):r(t)})})},t.prototype.verifyRequest=function(t){var e={},r=t.busi,n=t.tmpl,a=t.args;return r=Number(r),n=Number(n),isNaN(r)&&(e.errMsg=r+" is unvalid, expected number"),isNaN(n)&&(e.errMsg=n+" is unvalid, expected number"),"[object Object]"!==Object.prototype.toString.call(a)&&(e.errMsg="args is unvalid, expected object"),e},t.prototype.addRetMsg=function(t){if(t&&t.base_resp&&t.base_resp.ret){var e=t.base_resp.ret.toString();t.retMsg=r[e]||""}return t},t);function t(t){this.CGI=t.CGI}function w(t){var e="";if(/^[0-9]{4}-[0-9]{2}-[0-9]{2}/.test(t))e+=new Date(t).getTime();else if(/^\d{13}$/.test(t))e+=t;else if(/^\d{8}$/.test(t)){var r=t.substr(0,4)+"-"+t.substr(4,2)+"-"+t.substr(6,2);e+=new Date(r).getTime()}return parseInt(e)}function A(t){var e=new Date(t);return[e.getFullYear(),e.getMonth()+1,e.getDate()].map(n).join("-")}function j(t){var e=new Date(t);return[e.getFullYear(),e.getMonth()+1,e.getDate()].map(n).join("")}function i(t){(new Date).getTime();var e=(new Date).getTime()-24*t*60*60*1e3;return j(new Date(e))}function I(){return w(A((new Date).getTime()))}function n(t){return(t=t.toString())[1]?t:"0"+t}function g(t){for(t=""+t;t.length<4;)t="0"+t;return t.replace(/(\d{2})(\d{2})/,"$1:$2")}function S(t,e){for(var r=null,n=0;n<e.length;n++){var a=e[n];if(a.refdate===t){r=a;break}}return r}function O(t,e,r){for(var n=null,a=0;a<r.length;a++){var o=r[a];if(o.refdate===t&&parseInt(o.scene,10)===e){n=o;break}}return n}function y(t,e,r){for(var n=null,a=0;a<r.length;a++){var o=r[a];if(parseInt(o.refhour,10)===t&&parseInt(o.scene,10)===e){n=o;break}}return n}function b(t,e){for(var r=null,n=0;n<e.length;n++){var a=e[n];if(a.refhour&&parseInt(a.refhour,10)===t){r=a;break}if(a.date_hour){var o=a.date_hour||"";if(100*o.slice(o.length-2,o.length)===t){r=a;break}}}return r}function s(t,e){var r=e.isDrawDiff;if(void 0!==r&&r)return function(t,e){e.xAxis;var r=e.yAxis,n=void 0===r?[]:r,a=e.mapInfo,o=void 0===a?{}:a,i=e.dateRange,s=e.diffDateRange,u=L(n);"[object String]"==Object.prototype.toString.call(n)&&(n=[n]);if(!Array.isArray(n))return;if(n.forEach(function(t){var e=t;t&&t.name&&(e=t.name),u.series.push({data:[],name:o[e],id:e})}),i.begin&&i.end)for(var f=w(i.begin),c=w(i.end),d=I(),l=f;l<=c&&l<d;l+=864e5){if(u.xAxis.categories.push(A(l)),m=S(j(l),t))for(h=0;h<2;h++){g=E(v=n[h]&&n[h].name?n[h].name:n[h],u.series);var p=m[v];p="[object Function]"===Object.prototype.toString.call(n[h].formatFunc)?n[h].formatFunc(p):parseInt(p),g.data.push(p)}else for(var h=0;h<2;h++){(g=u.series[h]).data.push(0)}}if(s.begin&&s.end)for(f=w(s.begin),c=w(s.end),d=I(),l=f;l<=c&&l<d;l+=864e5){var m;if(u.xAxis.categories.push(A(l)),m=S(j(l),t))for(h=2;h<4;h++){var v;g=E(v=n[h]&&n[h].name?n[h].name:n[h],u.series),p=m[v];p="[object Function]"===Object.prototype.toString.call(n[h].formatFunc)?n[h].formatFunc(p):parseInt(p),g.data.push(p)}else for(var h=0;h<u.series.length;h++){var g;(g=u.series[h]).data.push(0)}}return u}(t,e);var n=e.xAxis,a=void 0===n?"refdate":n,o=e.autoFillDate;return"refdate"===a&&(void 0!==o&&o)?function(t,e){var r=e.yAxis,n=void 0===r?[]:r,a=e.dateRange,o=void 0===a?{begin:(new Date).getTime()-6048e5,end:(new Date).getTime()}:a,i=e.mapInfo,s=void 0===i?{}:i,u=e.includeScene,f=void 0!==u&&u,c=L(n);"[object String]"==Object.prototype.toString.call(n)&&(n=[n]);if(!Array.isArray(n))return;if(n.forEach(function(t){var e=t;t&&t.name&&(e=t.name),c.series.push({data:[],name:s[e],id:e})}),o&&o.begin&&o.end)for(var d=w(o.begin),l=w(o.end),p=I(),h=d;h<=l&&h<p;h+=864e5){c.xAxis.categories.push(A(h));var m=void 0;if(f){var v=e.scene;m=O(j(h),v,t)}else m=S(j(h),t);if(m)for(b=0;b<n.length;b++){var g=n[b]&&n[b].name?n[b].name:n[b],y=(D=E(g,c.series),m[g]);y="[object Function]"===Object.prototype.toString.call(n[b].formatFunc)?n[b].formatFunc(y):parseInt(y),D.data.push(y)}else for(var b=0;b<c.series.length;b++){var D;(D=c.series[b]).data.push(0)}}var x=[],C=c.xAxis.categories.length;if(C<=6)for(h=0;h<C;h++)x.push(h);else{var F=Math.floor(C/6);for(h=0;h<C;h+=F){if(6===x.length){x.push(C-1);break}x.push(h)}}return c.xAxis.tickPositions=x,c}(t,e):"refhour"===a?function(t,e){var r=e.yAxis,n=void 0===r?[]:r,a=e.mapInfo,o=void 0===a?{}:a,i=e.includeScene,s=void 0!==i&&i,u=L(n);"[object String]"==Object.prototype.toString.call(n)&&(n=[n]);if(!Array.isArray(n))return;n.forEach(function(t){var e=t;t&&t.name&&(e=t.name),u.series.push({data:[],name:o[e],id:e})});for(var f=0;f<=2300;f+=100){u.xAxis.categories.push(g(f));var c=void 0;if(s){var d=e.scene;c=y(f,d,t)}else c=b(f,t);if(c)for(h=0;h<n.length;h++){var l=n[h]&&n[h].name?n[h].name:n[h],p=(m=E(l,u.series),c[l]);p="[object Function]"===Object.prototype.toString.call(n[h].formatFunc)?n[h].formatFunc(p):parseInt(p),m.data.push(p)}else for(var h=0;h<u.series.length;h++){var m;(m=u.series[h]).data.push(0)}}var v=[];for(f=0;f<23;f+=4)v.push(f),23<f+4&&v.push(23);return u.xAxis.tickPositions=v,u}(t,e):function(t,e){var r=e.xAxis,n=void 0===r?"refdate":r,a=e.yAxis,o=void 0===a?[]:a,i=e.mapInfo,s=void 0===i?{}:i,u=L(o);"[object String]"==Object.prototype.toString.call(o)&&(o=[o]);if(!Array.isArray(o))return;o.forEach(function(t){var e;e=t&&t.name?t.name:t,u.series.push({data:[],name:s[e],id:e})}),t=function(t){return t.sort(function(t,e){return t.refdate>e.refdate?1:-1})}(t);for(var f=0;f<t.length;f++){var c=t[f];u.xAxis.categories.push(c[n])}for(f=0;f<o.length;f++)for(var d=o[f]&&o[f].name?o[f].name:o[f],l=0;l<t.length;l++){var p=E(d,u.series),h=t[l][d];h="[object Function]"===Object.prototype.toString.call(o[f].formatFunc)?o[f].formatFunc(h):parseInt(h),p.data.push(h)}return u}(t,e)}function L(t){var e;switch(t.length){case 4:e=["#07C160","#8CD68C","#4EA5EB","#C9E4F9"];break;default:e=["#07C160","#5E72CE","#F7B42F","#8D60CD","#E96345","#40CCE1","#F34587","#B744C6"]}return Object.assign({xAxis:{categories:[]},series:[]},{color:e})}function E(t,e){for(var r=null,n=0;n<e.length;n++){var a=e[n];if(a.id===t){r=a;break}}return r}function l(t,e){for(var r={},n=0;n<t.length;n++){var a=t[n].name?t[n].name:t[n],o=e[a]?e[a]:'_("暂无")';r[a]="[object Function]"===Object.prototype.toString.call(t[n].formatFunc)?t[n].formatFunc(o):o}return r}function u(t,e){var r=e.mainSceneList,a=void 0===r?[]:r,n=e.otherSceneList,o=void 0===n?[]:n,i=e.sceneMapInfo,s=void 0===i?{}:i,u=e.key,f=e.title,c=e.subTitle,d={series:[{name:"main",innerSize:"70%",cursor:"default",data:[]}],drilldown:{series:[{name:"sub",id:"other",cursor:"default",colors:["#8A9ADB","#A1AFE0","#BBC6E8","#D4DAEF","#E7EAF4"],data:[]}]},plotOptions:{pie:{dataLabels:{formatter:function(){var t=this.point.name+(this.point.drilldown?'_("（点击展开详情）")':""),e=function(t,e){return parseFloat((100*t/e).toFixed(2))}(this.point.y,this.point.total);return t+" "+this.point.y+"次 "+e+"%"}}}}},l=0,p=0;if(t.forEach(function(t){var e=parseInt(t.scene,10),r=s[e],n=parseInt(t[u],10);l+=n,-1<a.indexOf(e)?d.series[0].data.push({name:r,y:n}):-1<o.indexOf(e)&&(d.drilldown.series[0].data.push([r,n]),p+=n)}),0<l){if(0<p)if(1<d.drilldown.series[0].data.length)d.series[0].data.push({name:'_("更多")',y:p,drilldown:"other"});else{var h=d.drilldown.series[0].data[0];d.series[0].data.push({name:h[0],y:h[1]})}var m={title:{text:f,style:{color:"#353535",fontSize:"16px"},floating:!0,align:"center",verticalAlign:"middle",y:-40},subtitle:{text:""+function(t,e){var r=1e4,n="万";(t=parseFloat(t))<1e4?(r=1,n=""):t<1e8?(r=1e4,n="万"):t<1e9&&(r=1e8,n="亿");var a=e||1,o=t/r;return o-Math.floor(o)<1e-5&&(a=e||0),parseFloat((t/r).toFixed(a))+n}(l,1)+c,style:{color:"#9A9A9A",fontSize:"14px"},align:"center",verticalAlign:"middle",y:-20},chart:{events:{render:function(){for(var t=this.renderer.box.childNodes[5].childNodes[0].childNodes,e=!1,r=0,n=t.length;!e&&r<n;r++)"hidden"!==t[r].getAttribute("visibility")&&(e=!0);if(e){var a=this.series[0].group.element.getBoundingClientRect(),o=this.title.element.getBoundingClientRect();this.setTitle({x:a.left+a.width/2-o.left-o.width/2,y:this.series[0].center[1]})}else this.title.element.setAttribute("visibility","hidden")}}}};return d=Object.assign(d,m)}return null}function f(t){return t&&t.data?t.data:[]}var a=(o.prototype.getRawData=function(t){return this.CommonDao.getData(t)},o.prototype.drawLine=function(t,e){return this.CommonDao.get(t,e,this.formatLineData,this.requestFailureCb)},o.prototype.drawLineWithData=function(t,e){return this.formatLineFromData(t,e)},o.prototype.drawTable=function(t,e){return this.CommonDao.get(t,e,this.formatTableData,this.requestFailureCb)},o.prototype.drawPie=function(t,e){return this.CommonDao.get(t,e,this.formatPieData,this.requestFailureCb)},o.prototype.drawPieWithData=function(t,e){return this.formatPieFromData(t,e)},o.prototype.drawBarChart=function(t,e){return this.CommonDao.get(t,e,this.formatBarData,this.requestFailureCb)},o.prototype.drawYesterdayData=function(t,e){var r=i(1),n=i(2),a=i(7),o=function(t){var e=w(t);return j((t=new Date(e)).setMonth(t.getMonth()-1))}(r);return t&&t.args&&(t.args.refdate0=r,t.args.refdate1=n,t.args.refdate2=a,t.args.refdate3=o),e&&(e.dateList=[r,n,a,o]),this.CommonDao.get(t,e,this.formatYesterdayData,null)},o.prototype.formatLineData=function(t,e){var r=f(t),n=s(r,e),a=e.domId,o=void 0===a?"":a,i=e.LineChart;return(void 0===i?function(){}:i).render(o,n),{success:!0,data:r}},o.prototype.formatLineFromData=function(t,e){var r=s(t,e),n=e.domId,a=void 0===n?"":n,o=e.LineChart;return(void 0===o?function(){}:o).render(a,r),{success:!0,data:t}},o.prototype.formatPieFromData=function(t,e){var r=u(t,e),n=e.domId,a=void 0===n?"":n,o=e.PieChart;if(e)return(void 0===o?function(){}:o).render(a,r),{success:!0,data:t}},o.prototype.formatTableData=function(t,e){return function(t,e){var r=e.headList,n=(e.mapInfo,{head:[],body:[]});r.forEach(function(t){var e=t&&t.name?t.name:t;n.head.push({title:t.title,key:e,className:t.className?t.className:""})});for(var a=0;a<t.length;a++){for(var o=t[a],i={type:"default"},s=0;s<r.length;s++){var u=r[s].name?r[s].name:r[s];if(r[s].slot){var f=r[s].slot.name,c=r[s].slot.data;i[u]={type:r[s].type?r[s].type:"default",slot:f,data:l(c,o),className:r[s].contentClass?r[s].contentClass:""}}else{var d=o[u]?o[u]:'_("暂无")';i[u]={content:"[object Function]"===Object.prototype.toString.call(r[s].formatFunc)?r[s].formatFunc(d):d,className:r[s].contentClass?r[s].contentClass:""}}}n.body.push(i)}return n}(f(t),e)},o.prototype.formatYesterdayData=function(t,e){return function(t,e){for(var r=e.dateList,n=e.quatoList,a=[],o=0,i=r;o<i.length;o++){for(var s=i[o],u={refdate:s},f=S(s,t),c=0,d=n;c<d.length;c++){var l=d[c];u[l]=f?f[l]:0}a.push(u)}return a}(f(t),e)},o.prototype.formatPieData=function(t,e){var r=f(t),n=u(r,e),a=e.domId,o=void 0===a?"":a,i=e.PieChart;if(n)return(void 0===i?function(){}:i).render(o,n),{success:!0,data:r}},o.prototype.formatBarData=function(t,e){var r=function(t,e){var r=e.labelFormat,n=void 0===r?"":r,a=e.pointFormat,o=void 0===a?"":a,i=e.xAxisFormat,s=void 0===i?function(){}:i,u=e.xAxis,f=void 0===u?"":u,c=e.yAxis,d=void 0===c?"":c,l={plotOptions:{column:{dataLabels:{enabled:!1}}},xAxis:{categories:[]},yAxis:{labels:{format:n}},tooltip:{pointFormat:o},series:[{data:[]}]};return t&&0<t.length?(t.forEach(function(t){l.xAxis.categories.push(s(t[f])),l.series[0].data.push(t[d])}),l):null}(f(t),e),n=e.domId,a=void 0===n?"":n,o=e.ColummnChart;return!!r&&((void 0===o?function(){}:o).render(a,r),!0)},o.prototype.requestFailureCb=function(t){return t},o);function o(t){this.CommonDao=new e(t)}function c(t){this.Controller=new a(t)}return c.prototype.drawLine=function(t,e){return this.Controller.drawLine(t,e)},c.prototype.drawLineWithData=function(t,e){return this.Controller.drawLineWithData(t,e)},c.prototype.drawPie=function(t,e){return this.Controller.drawPie(t,e)},c.prototype.drawPieWithData=function(t,e){return this.Controller.drawPieWithData(t,e)},c.prototype.drawTable=function(t,e){return this.Controller.drawTable(t,e)},c.prototype.drawYesterdayData=function(t,e){return this.Controller.drawYesterdayData(t,e)},c.prototype.getRawData=function(t){return this.Controller.getRawData(t)},c.prototype.drawBarChart=function(t,e){return this.Controller.drawBarChart(t,e)},c},"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t=t||self).AnalysisMiddleware=e()});
